<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Workflow on Leonhard/Euler Compute Cluster - Blog</title><link rel=icon type=image/png href=img/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="I compiled some improvements to my workflow."><meta property="og:image" content><meta property="og:title" content="Workflow on Leonhard/Euler Compute Cluster"><meta property="og:description" content="I compiled some improvements to my workflow."><meta property="og:type" content="article"><meta property="og:url" content="https://kevinkle.in/posts/2019-02-28-leonhard/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-28T18:00:00+02:00"><meta property="article:modified_time" content="2019-02-28T18:00:00+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Workflow on Leonhard/Euler Compute Cluster"><meta name=twitter:description content="I compiled some improvements to my workflow."><script src=https://kevinkle.in/js/feather.min.js></script><link href=https://kevinkle.in/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://kevinkle.in/css/main.3a1de2917438aeff713f11261cc8e65bc6d4705113bc0ef12e161e5731d820b5.css></head><body><div class=content><header><div class=main><a href=https://kevinkle.in/>Blog</a></div><nav><a href=/about>Hello</a>
<a href=/tags>Tags</a>
<a href=/projects>Projects</a></nav></header><main><article><div class=title><h1 class=title>Workflow on Leonhard/Euler Compute Cluster</h1><div class=meta>Posted on Feb 28, 2019</div></div><section class=body><h1 id=abstract>Abstract</h1><p>Fortunately, ETH provides many of its students with access to Leonhard and Euler, computer clusters with CPUs and GPUs. Note that not every student is granted access to both - only some coursework or projects might qualify. I have spent and lost a fair amount of time due to poor Google results and will describe a setup for a simple workflow.</p><h1 id=connection>Connection</h1><p>In order to ssh to the server, you first need to connect to ETH&rsquo;s VPN.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh your_nethz@login.leonhard.ethz.ch
</span></span></code></pre></div><p>You will find yourself in your personal home directory right away.</p><h1 id=conda>Conda</h1><p>You can install python packages to your personal environment <a href=https://scicomp.ethz.ch/wiki/Python#Installing_a_Python_package.2C_using_PIP>via pip</a>. In many cases, you might favor working with conda for managing virtual environments, resolving dependencies and installing packages. Conda is not installed by the default. You can download an installer, e.g. minicanoda and run it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</span></span><span style=display:flex><span>bash Miniconda3-latest-Linux-x86_64.sh
</span></span></code></pre></div><p>Once installed, in order to be able to invoke conda from the command like, you want to add it to your bashrc file. Given that you installed conda in <code>$HOME</code>, add the following line to <code>~/.bashrc</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>source $HOME/miniconda3/bin/activate
</span></span></code></pre></div><p>Followingly, clone the git repository of your preference, including a <code>environment.yml</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>conda env create -f myenvironment.yml
</span></span></code></pre></div><p>All the steps so far only have to be executed once. You will need to activate the conda environment every time you instantiate a fresh connection to the cluster and intend to run code in this environment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>conda activate myenvironment
</span></span></code></pre></div><h1 id=submission-system>Submission system</h1><p>An activated enviroment will automatically be picked up by the submission system. In other words, you activate the environment in you own bash terminal, and can then run your python scripts by submitting <code>python script.py</code>.</p><p>For cpu usage run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bsub <span style=color:#e6db74>&#34;python script.py --batch_size 2 --n_epochs 50000&#34;</span>
</span></span></code></pre></div><p>For gpu usage run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bsub -R <span style=color:#e6db74>&#34;rusage[ngpus_excl_p=1]&#34;</span> <span style=color:#e6db74>&#34;python script.py --batch_size 2 --n_epochs 50000&#34;</span>
</span></span></code></pre></div><p>In case you have access to more GPUs, you can adapt the parameter. Students will usually only have access to one.</p><p>Always make sure to request a conservative amount of time, as your job might be killed when surpassing its threshold. The default duration is 2h. The argument can be either in minutes or hours:minutes format.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bsub -W 8:30 -R <span style=color:#e6db74>&#34;rusage[ngpus_excl_p=1]&#34;</span> <span style=color:#e6db74>&#34;python script.py --batch_size 2 --n_epochs 50000&#34;</span>
</span></span></code></pre></div><p>In order to retroactively inspect parameters of a given, completed job, the following will do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bhist -l <span style=color:#ae81ff>192240</span>
</span></span></code></pre></div><p>There are interesting features such as notifying yourself via email upon completion of a job. See more <a href=https://scicomp.ethz.ch/wiki/Using_the_batch_system>ETH wiki</a>, <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=reference-bsub">IBM reference</a></p><p>By default, standard output will be gathered in a file that is delivered to your home directory once the job is no longer running.
A simple way to track progress is to write to standard output and look into this file on the go. <code>bjobs</code> will tell you the job id of your job, say <code>192240</code>.
In order to investigate the standard output so far, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bpeek <span style=color:#ae81ff>192240</span>
</span></span></code></pre></div><h1 id=file-transfer>File transfer</h1><p>In order to transfer files, e.g. log files or loss function evaluations, use scp. Note that wildcards have to be escaped when using scp. E.g. to transfer files from Leonhard to your machine, run the following on your machine</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>scp your_nethz@login.leonhard.ethz.ch:~/repo/logs/<span style=color:#ae81ff>\*</span>.csv .
</span></span></code></pre></div><h1 id=further-reading>Further reading</h1><p><a href=https://scicomp.ethz.ch/wiki/>https://scicomp.ethz.ch/wiki/</a></p><p>Thanks to <a href=https://www.lorenzkuhn.com/>Lorenz</a>, <a href=https://www.linkedin.com/in/philip-junker/>Philip</a> and <a href=https://www.linkedin.com/in/dfischmann/>Daniel</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/tech>tech</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/kklein title=GitHub><i data-feather=github></i></a><a class=soc href=https://twitter.com/kevkle title=Twitter><i data-feather=twitter></i></a></div><div class=footer-info>2023 Â© Kevin Klein |</div></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-SGRSG6Y0WX","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></div></body></html>