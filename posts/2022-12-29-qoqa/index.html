<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>QoQa Looks Mostly Legit - Blog</title><link rel=icon type=image/png href=img/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Scraping indications of remaining stock"><meta property="og:image" content><meta property="og:url" content="https://kevinkle.in/posts/2022-12-29-qoqa/"><meta property="og:site_name" content="Blog"><meta property="og:title" content="QoQa Looks Mostly Legit"><meta property="og:description" content="Scraping indications of remaining stock"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-29T07:38:07+02:00"><meta property="article:modified_time" content="2022-12-29T07:38:07+02:00"><meta property="article:tag" content="Tech"><meta name=twitter:card content="summary"><meta name=twitter:title content="QoQa Looks Mostly Legit"><meta name=twitter:description content="Scraping indications of remaining stock"><script src=https://kevinkle.in/js/feather.min.js></script><link href=https://kevinkle.in/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://kevinkle.in/css/main.3a1de2917438aeff713f11261cc8e65bc6d4705113bc0ef12e161e5731d820b5.css></head><body><div class=content><header><div class=main><a href=https://kevinkle.in/>Blog</a></div><nav><a href=/about>Hello</a>
<a href=/tags>Tags</a>
<a href=/projects>Projects</a>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></nav></header><main><article><div class=title><h1 class=title>QoQa Looks Mostly Legit</h1><div class=meta>Posted on Dec 29, 2022</div></div><section class=body><h1 id=what>What</h1><p><a href=https://www.qoqa.ch/>QoQa</a> - I&rsquo;m still very unsure about its pronunciation -
is a Swiss e-commerce business. Per product category - of which there are ten -
they usually offer a single product at a time. A given product is offered at a supposedly
low price point during a fairly short time window, usually hours
or days. Importantly, it is advertised as though QoQa had access to a fixed
amount of stock per product. Once this stock is exhausted, users can no longer
purchase or order any more of it.</p><p>My understanding is that this type of business model can bring home advantages for
both seller and buyer simultaneously. At the same time, it certainly also allows
for the manipulation of potential buyer&rsquo;s behavior: If a user is under the impression
that the herd one runs one way, they are biased towards running the same way. This bears the
question of how QoQa could evoke the impression of the herd running one way.</p><p>Two manipulative ideas came to mind: Generally inflating sales volumes as well as indicating low
remaining stock percentages. As a consequence, I was curious to look for indications of such
practices. Hence, I thought it could be interesting to scrape the
information that QoQa displays regarding the remaining amount of stock of a given product.</p><p>This is an example of the information QoQa provides on a given product; taken from its wine
product category &lsquo;Qwine&rsquo;:</p><p><img src=/imgs/qoqa/qoqa.png alt></p><h1 id=how>How</h1><p>Since the remaining stock percentage is hidden behind the execution JavaScript, I couldn&rsquo;t simply
talk to a HTTP end point to obtain a ready-to-go HTML file with all of the necessary
content. Instead, I used <a href=https://www.selenium.dev/>selenium</a> to, bluntly put, mock the
execution of an actual browser to obtain the corresponding content of the website.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> selenium <span style=color:#f92672>import</span> webdriver
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> selenium.webdriver.firefox.options <span style=color:#f92672>import</span> Options
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>options <span style=color:#f92672>=</span> Options()
</span></span><span style=display:flex><span>options<span style=color:#f92672>.</span>headless <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>driver <span style=color:#f92672>=</span> webdriver<span style=color:#f92672>.</span>Firefox(options<span style=color:#f92672>=</span>options)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>driver<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;https://www.qoqa.ch/fr&#34;</span>)
</span></span></code></pre></div><p>Now, the goal was to retrieve the remaining stock indication of every product
displayed on the front page. A brief look into my browser&rsquo;s inspector was sufficient
to identify the pattern followed by the <code>div</code> containers with product information. Here,
the respective <code>div</code> containers always carried the id <code>qoqa-gauge-for-offer-123456</code>.</p><p><img src=/imgs/qoqa/inspector.png alt></p><p>This allowed for the extraction of the offer id, uniquely identifying a given product, as
well as the indication of the currently remaining stock.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> selenium.webdriver.common.by <span style=color:#f92672>import</span> By
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>offer_elements <span style=color:#f92672>=</span> driver<span style=color:#f92672>.</span>find_elements(
</span></span><span style=display:flex><span>    By<span style=color:#f92672>.</span>XPATH, <span style=color:#e6db74>&#34;//*[starts-with(@id, &#39;qoqa-gauge-for-offer&#39;)]&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> [(_offer_id(element), _remainder(element)) <span style=color:#66d9ef>for</span> element <span style=color:#f92672>in</span> offer_elements]
</span></span></code></pre></div><p>Being able to scrape the relevant data once is all and well. Yet, for this to make any sense,
two components for this were missing: storage of information and orchestration, i.e. scheduled,
repeated execution of the scraping. I opted for the low-key approach of doing both storage as well as scraping on my local machine.</p><p>My storage consisted of a sqlite database. It was written to every time the scraping took place.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sqlite3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>con <span style=color:#f92672>=</span> sqlite3<span style=color:#f92672>.</span>connect(<span style=color:#e6db74>&#34;/Users/kevin/Code/qoqa/qoqa.db&#34;</span>)
</span></span><span style=display:flex><span>cur <span style=color:#f92672>=</span> con<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;CREATE TABLE IF NOT EXISTS stock (offer_id TEXT, timestamp TEXT, stock REAL)&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>con<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>values <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;, &#34;</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;(&#39;</span><span style=color:#e6db74>{</span>datum[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;, DATETIME(&#39;now&#39;), </span><span style=color:#e6db74>{</span>datum[<span style=color:#ae81ff>1</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74>)&#34;</span> <span style=color:#66d9ef>for</span> datum <span style=color:#f92672>in</span> data)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> len(data) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;INSERT INTO stock (offer_id, timestamp, stock) VALUES </span><span style=color:#e6db74>{</span>values<span style=color:#e6db74>}</span><span style=color:#e6db74> ;&#34;</span>)
</span></span><span style=display:flex><span>con<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>con<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><p>I used <code>crontab</code> for orchestration on my local machine - executing a simple script every 5 minutes. To do so I ran <code>crontab -e</code> and inserted:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>SHELL<span style=color:#f92672>=</span>/usr/local/bin/fish
</span></span><span style=display:flex><span>*/5 * * * * source /Users/kevin/Code/qoqa/script.sh &gt;&gt; /users/kevin/Code/qoqa/logs.txt
</span></span></code></pre></div><p>In case you are curious about shifting the scraping to the cloud: it seems as though a headless browser via
selenium can <a href=https://stackoverflow.com/questions/70661914/can-i-use-selenium-webdriver-with-google-cloud-functions>currently not be run via Python</a>
on Google Cloud Functions while
<a href=https://dev.to/googlecloud/using-headless-chrome-with-cloud-run-3fdp>it should be feasible</a>
via Google Cloud Run.</p><p>Thankfully my IP has never been blocked by QoQa. :)</p><h1 id=results>Results</h1><p>Shown below is the evolution of remaining stock percentages per product according the QoQa&rsquo;s
website, sampled every 5 minutes. Importantly, if a product is sold out, it is no
longer displayed, i.e. it doesn&rsquo;t show up at 0% stock. I scraped all of the products between
the 25th and the 29th of December 2022.</p><p><img src=/imgs/qoqa/stock.png alt></p><p>A first reassuring observation is that indeed every product seems to start at 100%.
More specifically, one can see that:</p><h2 id=1>1</h2><p>Some products stay at exactly 1% for a bizarrely long time before being properly sold out.
Assuming that purchases made will not be revoked, this could potentially indicate that
QoQa deceivingly deflates the displayed amount of remaining stock to evoke the feeling
of being under pressure among users.</p><h2 id=2>2</h2><p>The stock of one product is not monotonically decreasing.
While the concept of restocking is certainly not an impossibility, it seems not too likely
given QoQa&rsquo;s mode of operation. Maybe just a bug, after all? Maybe a massive order got canceled?</p><h2 id=3>3</h2><p>Some stock is decreasing around the clock and <em>fairly</em> evenly distributed across times of the day.
This looks a little fishy to my layman eyes. I would expect a distinct period of radio
silence between 2am and 6am.</p><h2 id=4>4</h2><p>The update resolution seems to vary over time, creating large steps. Technical problems?</p><h2 id=5>5</h2><p>The displayed stock of every(!) product falls extremely fast immediately after its publication. This even
applies to products finishing at over 50% of remaining stock. It seems that QoQa <a href=https://www.qoqa.ch/fr/concept>app users can pre-purchase 15&rsquo; early</a>.
Maybe these purchases are batched to very briefly after the start of a new deal. Yet, is this massive
trend really just people&rsquo;s excitement to jump at a new deal? Or is this QoQa&rsquo;s involvement
to make sure hardly any products ever sit around at a very unsexy 82%?</p><p>An alternative hypothesis could be that core users might have developed a habit to check the website at the same hour every day. Therefore
it could be imaginable that almost all purchases over a >24h cycle do happen in the first few minutes.</p><h1 id=conclusion>Conclusion</h1><p>Some details do look a little strange. Yet, overall I would&rsquo;ve imagined the numbers to look more suspicious.
It doesn&rsquo;t seem outrageous to believe that the displayed stock does indeed represent the best knowledge
of QoQa&rsquo;s IT systems.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/tech>tech</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/kklein title=GitHub><i data-feather=github></i></a><a class=soc href=https://twitter.com/kevkle title=Twitter><i data-feather=twitter></i></a></div><div class=footer-info>2024 © Kevin Klein |</div></footer><script>feather.replace()</script></div></body></html>